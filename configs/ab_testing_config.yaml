# A/B Testing Configuration for Aphrodite Engine
# Phase 8 - SSR-Focused MLOps & Production Observability

# Global A/B Testing Settings
ab_testing:
  enabled: false
  default_traffic_split_percent: 10.0  # Percentage of traffic to variant B
  max_test_duration_minutes: 1440      # 24 hours maximum
  metrics_window_size: 1000            # Rolling window for metrics calculation
  
  # Success criteria for promoting variant B
  success_criteria:
    min_improvement_threshold: 5.0           # % improvement required
    max_error_rate_increase_percent: 50.0    # Maximum allowed error rate increase
    max_latency_increase_percent: 20.0       # Maximum allowed latency increase
    min_sample_size: 100                     # Minimum requests before decision
  
  # Failure criteria for automatic rollback
  failure_criteria:
    max_error_rate_percent: 5.0              # Immediate rollback threshold
    max_latency_ms: 5000.0                   # Immediate rollback threshold
    max_consecutive_errors: 10               # Consecutive errors before rollback
    monitoring_failure_limit: 5              # Monitor failures before emergency rollback

# Automated Monitoring Settings
monitoring:
  enabled: true
  check_interval_seconds: 30               # How often to check metrics
  alert_retention_count: 1000              # Number of alerts to keep in memory
  
  # Monitoring thresholds
  thresholds:
    critical_error_rate: 10.0              # % - immediate rollback
    warning_error_rate: 5.0                # % - generate warning
    critical_latency_ms: 3000.0            # ms - immediate rollback
    warning_latency_ms: 1500.0             # ms - generate warning
    min_sample_size: 50                    # minimum requests for actions

# Model Variant Management
model_variants:
  max_concurrent_models: 2                 # Maximum models loaded simultaneously
  health_check_interval_seconds: 300      # How often to check model health
  auto_unload_unused_minutes: 60          # Unload models not used for this time
  
  # Model loading configuration
  loading:
    timeout_seconds: 600                   # Maximum time to wait for model loading
    retry_attempts: 3                      # Number of retry attempts on failure
    memory_threshold_percent: 85.0         # Stop loading new models at this memory usage

# Integration Settings
integration:
  dtesn_cache_enabled: true               # Enable DTESN cache integration
  aar_orchestration_enabled: true         # Enable AAR orchestration
  echo_systems_enabled: true              # Enable Echo systems integration
  
  # API endpoints configuration
  api:
    enable_ab_testing_routes: true         # Enable /v1/ab-testing/* endpoints
    enable_monitoring_routes: true        # Enable monitoring endpoints
    require_authentication: true          # Require API keys for AB testing operations

# Logging and Observability
logging:
  level: INFO
  structured_logging: true
  include_request_ids: true
  audit_trail_enabled: true              # Log all A/B test events
  
  # Log destinations
  destinations:
    console: true
    file: "/tmp/ab_test.log"
    prometheus_metrics: true

# Example Test Configurations
example_tests:
  # Quick performance test
  performance_test:
    traffic_split_percent: 5.0
    test_duration_minutes: 30
    success_criteria:
      min_improvement_threshold: 2.0
    failure_criteria:
      max_error_rate_percent: 3.0
  
  # Conservative rollout test  
  conservative_test:
    traffic_split_percent: 1.0
    test_duration_minutes: 120
    success_criteria:
      min_improvement_threshold: 10.0
    failure_criteria:
      max_error_rate_percent: 1.0
  
  # Aggressive performance test
  aggressive_test:
    traffic_split_percent: 25.0
    test_duration_minutes: 15
    success_criteria:
      min_improvement_threshold: 15.0
    failure_criteria:
      max_error_rate_percent: 8.0

# Security Settings
security:
  ip_whitelist: []                       # Empty = allow all IPs
  rate_limiting:
    requests_per_minute: 100             # Rate limit for AB testing API calls
    burst_size: 10                       # Burst allowance
  
  audit:
    log_all_requests: true               # Log all A/B testing API requests
    include_request_data: false          # Include request payloads in logs
    retention_days: 30                   # How long to keep audit logs